<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Pitches</title>
    <link rel="stylesheet" href="css/dashboard.css">
    <script src="js/auth-guard.js"></script>
</head>

<body>

    <!-- Overlay for mobile -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <aside class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            Portfolio Admin
        </div>
        <ul class="nav-list">
            <li class="nav-item">
                <a href="dashboard.html" class="nav-link">Dashboard</a>
            </li>
            <li class="nav-item">
                <a href="pitches.html" class="nav-link active">Pitches</a>
            </li>
            <li class="nav-item">
                <a href="contact-requests.html" class="nav-link">Contact Requests</a>
            </li>
            <li class="nav-item">
                <a href="mentorship-requests.html" class="nav-link">Mentorship Requests</a>
            </li>
        </ul>
        <div class="logout-section">
            <a href="login.html" class="nav-link" style="color: #ef4444;">Logout</a>
        </div>
    </aside>

    <main class="main-content">
        <header class="top-header">
            <div class="header-left">
                <button class="hamburger-btn" id="hamburgerBtn">
                    ☰
                </button>
                <div class="welcome-text">Pitches Received</div>
            </div>
            <div class="date-display" id="currentDate"></div>
        </header>

        <div class="dashboard-container">
            <div class="section-title">New Pitches</div>

            <div class="table-container">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Sector</th>
                            <th>Date</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody id="pitchesTableBody">
                        <!-- Content will be seeded by JS -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <script>
        // API Base URL
        const API_BASE_URL = 'https://rohit-portfolio-backend.vercel.app/api/v1';

        /**
         * Get Pitch Requests (Admin)
         */
        async function getPitchRequests(skip = 0, limit = 10) {
            try {
                const response = await fetch(`${API_BASE_URL}/pitch/?skip=${skip}&limit=${limit}`);
                if (!response.ok) throw new Error(await response.text());
                return { success: true, ...await response.json() };
            } catch (error) {
                console.error("Get Pitch Requests Error:", error);
                return { success: false, error: error.message, data: [], count: 0 };
            }
        }

        /**
         * Format date
         */
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }

        /**
         * Toggle Row Visibility
         */
        function toggleRow(id) {
            const detailRow = document.getElementById(`detail-${id}`);
            const btn = document.getElementById(`btn-${id}`);

            if (detailRow.style.display === 'table-row') {
                detailRow.style.display = 'none';
                btn.classList.remove('active');
                btn.innerHTML = '▼'; // Down arrow
            } else {
                detailRow.style.display = 'table-row';
                btn.classList.add('active');
                btn.innerHTML = '▲'; // Up arrow
            }
        }

        /**
         * Render Pitch Requests Table
         */
        async function renderPitchRequests() {
            const tableBody = document.getElementById('pitchesTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">Loading...</td></tr>';

            const result = await getPitchRequests(0, 50);

            tableBody.innerHTML = '';

            if (!result.success || !result.data || result.data.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No pitches found</td></tr>';
                return;
            }

            result.data.forEach((pitch, index) => {
                const uniqueId = `pitch-${index}`;

                // File link
                let fileLink = 'None';
                if (pitch.proposal_file) {
                    fileLink = `<a href="${pitch.proposal_file}" target="_blank" style="color: var(--primary-color); font-weight: 500;">Download Proposal</a>`;
                }

                // Main Row
                const trMain = document.createElement('tr');
                trMain.innerHTML = `
                    <td>
                        <div style="font-weight: 500; color: var(--text-primary);">${pitch.name || 'N/A'}</div>
                    </td>
                    <td>${pitch.company_name || 'N/A'}</td>
                    <td>${pitch.sector || 'N/A'}</td>
                    <td>${pitch.created_at ? formatDate(pitch.created_at) : 'N/A'}</td>
                    <td style="text-align: center;">
                        <button id="btn-${uniqueId}" class="expand-btn" onclick="toggleRow('${uniqueId}')" title="View Details">▼</button>
                    </td>
                `;
                tableBody.appendChild(trMain);

                // Details Row
                const trDetail = document.createElement('tr');
                trDetail.id = `detail-${uniqueId}`;
                trDetail.style.display = 'none'; // Hidden by default
                trDetail.className = 'details-row hidden-row';

                trDetail.innerHTML = `
                    <td colspan="5">
                        <div class="details-content">
                            <div class="detail-group">
                                <span class="detail-label">Investment Required</span>
                                <span class="detail-value" style="color: #16a34a; font-weight: 600;">${pitch.investment_required || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <span class="detail-label">Contact Email</span>
                                <span class="detail-value">${pitch.email || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <span class="detail-label">Contact Phone</span>
                                <span class="detail-value">${pitch.contact_number || 'N/A'}</span>
                            </div>
                            <div class="detail-group">
                                <span class="detail-label">Proposal File</span>
                                <span class="detail-value">${fileLink}</span>
                            </div>
                            <div class="detail-group" style="grid-column: 1 / -1;">
                                <span class="detail-label">Pitch Summary</span>
                                <div class="detail-value long-text">${pitch.pitch_summary || 'No summary provided.'}</div>
                            </div>
                        </div>
                    </td>
                `;
                tableBody.appendChild(trDetail);
            });
        }

        /**
         * View Pitch Details
         */
        function viewPitch(id) {
            if (!id) {
                console.log('Pitch ID not available');
                return;
            }
            alert('Pitch ID: ' + id + '\n\nThis feature can be expanded to show full pitch details including proposal file.');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // 1. Mobile Menu Toggle
            const hamburgerBtn = document.getElementById('hamburgerBtn');
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');

            const toggleSidebar = () => {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
            };

            hamburgerBtn.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);

            // 2. Set Date
            const dateElement = document.getElementById('currentDate');
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const today = new Date();
            dateElement.textContent = today.toLocaleDateString('en-US', options);

            // 3. Load Pitch Requests from API
            renderPitchRequests();
        });
    </script>
</body>

</html>